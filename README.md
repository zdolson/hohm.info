# hohm.info

Home listings with deep tag knowledge. Next.js 15 + Payload 3 + Postgres (Supabase).

## Prerequisites

- Node.js 24+, pnpm 9+
- Docker (or OrbStack) — for local Supabase

## Setup

1. `pnpm install`
2. Copy `.env.example` → `.env.local` (defaults point to local Supabase)
3. `pnpm db:start` — starts local Postgres + Studio via Supabase CLI
4. `pnpm dev` — app at http://localhost:3000, admin at /admin
5. Local Studio at http://localhost:54323 (inspect tables, run SQL)

## Scripts

| Script                | Purpose                                                |
| --------------------- | ------------------------------------------------------ |
| `pnpm dev`            | Start dev server                                       |
| `pnpm build`          | Production build                                       |
| `pnpm start`          | Start production server                                |
| `pnpm lint`           | ESLint                                                 |
| `pnpm format`         | Prettier format                                        |
| `pnpm test`           | Vitest unit/integration                                |
| `pnpm test:e2e`       | Playwright E2E                                         |
| `pnpm seed`           | Seed data via Payload Local API                        |
| `pnpm generate:types` | Regenerate `src/payload-types.ts`                      |
| `pnpm db:start`       | Start local Supabase (Postgres + Studio)               |
| `pnpm db:stop`        | Stop local Supabase                                    |
| `pnpm db:status`      | Show local Supabase connection info                    |
| `pnpm db:reset`       | Reset local DB (re-applies Supabase migrations + seed) |
| `pnpm migrate:create` | Create Payload migration (for staging/prod)            |
| `pnpm migrate`        | Run pending Payload migrations                         |

## Database & Migrations

### Who owns what

- **Payload + Drizzle** own the schema. Collections in `src/collections/` are the source of truth.
- **Supabase CLI** provides local Postgres infrastructure only. Do NOT use `supabase/migrations/` for Payload-managed tables.

### Environments

| Environment             | DB                        | Schema sync                                      |
| ----------------------- | ------------------------- | ------------------------------------------------ |
| **Local**               | `supabase start` (Docker) | Payload **push** mode — auto-syncs on `pnpm dev` |
| **Staging** (`develop`) | Supabase project #1       | `payload migrate` in CI                          |
| **Production** (`main`) | Supabase project #2       | `payload migrate` in CI                          |

### Dev workflow

1. Edit collections in `src/collections/*.ts`
2. `pnpm dev` — Drizzle push auto-syncs schema to local Postgres
3. Iterate freely; local DB is a disposable sandbox

### Migration workflow (staging / prod)

1. Finish feature, stabilize schema locally
2. `pnpm migrate:create` — generates migration in `src/migrations/`
3. Commit migration file
4. On merge to `develop` → CI runs `payload migrate` against staging
5. On merge to `main` → CI runs `payload migrate` against production

### Rules

- Never connect to remote Supabase from local dev
- Never run `push` against staging or production
- Keep migration files in version control
- Don't mix Supabase CLI migrations with Payload migrations for the same tables

## Branches

- `main` — production
- `develop` — staging; PRs merge here first
- `feature/*` — branches off `develop`

## Types

`src/payload-types.ts` is generated by `payload generate:types` (also runs on postinstall). Regenerate: `pnpm generate:types`.
